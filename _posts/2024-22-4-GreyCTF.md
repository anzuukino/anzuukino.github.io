---
title: "GreyCTF 2024"
date: 2024-04-22 00:00:00 +0800
categories: [CTF Writeup]
tags: [MYSQL, Base64]
---



## No Sql Injection
```
I asked My friend Jason to build me a new e-commerce website. We just finished the login system and there's already bugs ü§¶

Author: jro

http://challs.nusgreyhats.org:33336

```

Ph√¢n t√≠ch qua th√¨ b√†i n√†y c√≥ c√°c ch·ª©c nƒÉng ch√≠nh sau

+ /api/register/1

```js
app.post('/api/register/1', async (req, res) => {
    try {
        let { username } = req.body;

        username = decode(username);

        const token = btoa(JSON.stringify({
            name: username,
            admin: false
        }));
        console.log(token);

        await query("insert into tokens values (?)", [token]);

        res.json({ "err": false, "token": token });
    } catch (err) {
        console.log(err);
        res.json({ "err": true });
    }
})
```

+ /api/register/2

```js
app.post('/api/register/2', async (req, res) => {
    try {
        let { password, token } = req.body;
        password = decode(password);
        token = decode(token);

        const result = await query("select 1 from tokens where token = ?", [token]);
        console.log(result);
        if (result.length != 1) {
            return res.json({ err: "Token not found!" });
        }

        await query("delete from tokens where token = ?", [token]);

        const { name, admin } = JSON.parse(atob(token));
        console.log(JSON.parse(atob(token)))

        await query("insert into users (name, password, admin) values (?, ?, ?)", [name.toString(), password, admin === true]);

        res.json({ "err": false });
    } catch (err) {
        console.log(err);
        res.json({ "err": true });
    }
})
```
+ /api/login

```js
app.post('/api/login', async (req, res) => {
    try {
        let { password, username } = req.body;
        password = decode(password);
        username = decode(username);

        const result = await query("select admin from users where name = ? and password = ?", [username, password]);

        if (result.length != 1) {
            return res.json({ err: "Username or password did not match" });
        }

        if(result[0].admin) {
            res.json({ "err": false, "msg": config.flag});
        } else {
            res.json({ "err": false, "msg": "You've logged in successfully, but there's no flag here!"});
        }

        // Prevent too many records from filling up the database
        await query("delete from users where name = ? and password = ?", [username, password]);
    } catch (err) {
        console.log(err);
        res.json({ "err": true });
    }
})

```

Gi·∫£i th√≠ch c√°c api endpoint

+ `/register/1` s·∫Ω nh·∫≠n `username` khi ch√∫ng ta post data, sau ƒë√≥b·∫±ng c√°ch th√™m v√†o m·ªôt `key:value - admin:false` v√†o v√† chuy·ªÉn sang d·∫°ng json v√† base64 encode n√≥

![image](https://i.imgur.com/qZIVrvt.png)

Sau ƒë√≥ backend s·∫Ω th√™m token n√†y v√†o b·∫£ng `tokens` v√† g·ª≠i tr·∫£ ta token nh∆∞ tr√™n

+ `/register/2` s·∫Ω nh·∫≠n `password` v√† `token` (c·∫£ 2 ƒë·ªÅu ƒë√£ b·ªã base64) khi ch√∫ng ta post data, sau ƒë√≥ decode c·∫£ 2 v√† ki·ªÉm tra xem `token` ƒë√£ c√≥ trong db ch∆∞a, n·∫øu c√≥ th√¨ parse n√≥ th√†nh json v√† l·∫•y d·ªØ li·ªáu c·ªßa c√°c tr∆∞·ªùng `name`, `password`, `admin`

![image](https://i.imgur.com/F1KftEI.png)

Sau ƒë√≥ backend s·∫Ω xo√° token n√†y kh·ªèi database v√† th√™m c√°c tr∆∞·ªùng tr√™n v√†o b·∫£ng `users`

+ `/login` th√¨ ƒë∆°n gi·∫£n ch·ªâ l√† check xem account c√≥ ph·∫£i l√† admin kh√¥ng c√≥ th√¨ in ra flag, kh√¥ng th√¨ kh√¥ng in g√¨ c·∫£

V·∫≠y trong n√†y c√≥ c√°i g√¨ t·∫≠n d·ª•ng ƒë∆∞·ª£c ƒë·ªÉ khai th√°c ? Th√¥ng th∆∞·ªùng so s√°nh c·ªßa mysql l√† case-insensitive t·ª©c l√† 'a' == 'A' v·∫≠y b·∫±ng 1 c√°ch n√†o ƒë·∫•y ch√∫ng ta c√≥ th·ªÉ ƒëi·ªÅu khi·ªÉn c√°i token c·ªßa ch√∫ng ta v√† khi parse n√≥ th√¨ n√≥ s·∫Ω ra data m·ªôt c√°ch kh√°c th∆∞·ªùng

T·ª´ ƒë√≥ token th√¥ng th∆∞·ªùng l√†

```json
{"name":"yuu","admin":false}
```

Sau khi b·ªã ch√∫ng ta ch·ªânh s·ª≠a v√† n√≥ b·ªã bi·∫øn ƒë·ªïi th√†nh

```json
{"name":"yuu","admin":true}
```

V√¨ ch√∫ng ta ch·ªâ c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c gi√° tr·ªã c·ªßa username n√™n ch√∫ng ta ph·∫£i l√†m sao ƒë√≥ ƒë·ªÉ ph√° d·∫•u `"` ƒë·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c ƒë·∫∑c t√≠nh c·ªßa JSON ·ªü ƒë√¢y ƒë√≥ ch√≠nh l√† ch·ªânh s·ª≠a in hoa, in th∆∞·ªùng c·ªßa c√°c k√Ω t·ª± ƒë·∫°i di·ªán cho d√¢u `"`

Sau khi ph√° ƒë∆∞·ª£c d·∫•u `"` v√† vi·∫øt ƒë∆∞·ª£c `admin = true` th√¨ ch√∫ng ta v·∫´n c√≤n 1 vi·ªác n·ªØa ph·∫ßn `admin = false` ·ªü ph√≠a sau v·∫´n c√≤n v√† s·∫Ω ghi ƒë√® gi√° tr·ªã `admin` ·ªü tr∆∞·ªõc, l√∫c n√†y ch√∫ng ta c√≥ th·ªÉ ti·∫øp t·ª•c ph√° gi√° tr·ªã c·ªßa `admin = false` ·ªü sau b·∫±ng c√°ch ch·ªânh l·∫°i k√Ω t·ª± in hoa -> th∆∞·ªùng c·ªßa k√Ω t·ª± ƒë·∫°i di·ªán cho gi√° tr·ªã `admin`

V√† c√≥ 1 ƒëi·ªÅu c·∫ßn l∆∞u √Ω l√† `JSON.stringify` khi parse c√°c JSON object n·∫øu c√°c k√Ω t·ª± ƒë√≥ kh√¥ng th·ªÉ decode qua `UTF-8` hay `UTF-16` th√¨ n√≥ s·∫Ω tr·∫£ v·ªÅ unicode code v√† escape n√≥ v√≠ d·ª• (`JSON.stringify('\uDF06')` -> `'"\\udf06"'` )

V·∫≠y ch√∫ng ta v·ª´a corrupt c√°i base64 token v√† ki·ªÉm tra xem c√°c k√Ω t·ª± ƒë√≥ c√≥ th·ªÉ decode qua `UTF-8` hay `UTF-16` kh√¥ng

D∆∞·ªõi ƒë√¢y l√† m·ªôt c√°ch m√¨nh t√¨m ƒë∆∞·ª£c

```js
safe : b'{"name":"yuu (\xac\x8aadmin\x8a:true-\xc2c\x8a3\xa2to","admin":false}',
malicious: b'{"name":"yuu ","admin":true,"c":"to","admOn":false}'
```

2 base64 c·ªßa payload tr√™n

```js
safe: eyJuYW1lIjoieXV1ICisimFkbWluijp0cnVlLcJjijOidG8iLCJhZG1PbiI6ZmFsc2V9,
malicious: eyJuYW1lIjoieXV1ICIsImFkbWluIjp0cnVlLCJjIjoidG8iLCJhZG1PbiI6ZmFsc2V9
```

Login b·∫±ng `username` ·ªü tr√™n (trong tr∆∞·ªùng h·ª£p payload c·ªßa m√¨nh l√† `yuu `) v√† password ta c√≥ flag

![image](https://i.imgur.com/pZyldot.png)



